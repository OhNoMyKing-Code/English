name: Build Windows EXE

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Show Node / npm / OS info
        run: |
          node -v
          npm -v
          ver
          where signtool || echo "signtool not found"

      - name: Build (electron-builder)
        env:
          CI: true
        run: npm run dist

      - name: List dist folder
        run: dir dist

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: dist/**

      # Optional: Code signing using a base64 PFX secret (UNCOMMENT and configure if you have a PFX)
      # - name: Decode PFX and sign executables (optional)
      #   if: ${{ secrets.WINDOWS_SIGN_PFX && secrets.WINDOWS_SIGN_PASSWORD }}
      #   run: |
      #     echo "$WINDOWS_SIGN_PFX" | Out-File -Encoding ascii pfx.b64
      #     certutil -decode pfx.b64 signing.pfx
      #     # Import PFX to certificate store (may require admin) OR use signtool with the pfx file
      #     # Example using signtool (assumes Windows SDK is installed on runner):
      #     for /R dist %f in (*.exe) do signtool sign /fd SHA256 /a /f signing.pfx /p "%WINDOWS_SIGN_PASSWORD%" "%f"
      #   shell: powershell
      #   env:
      #     WINDOWS_SIGN_PFX: ${{ secrets.WINDOWS_SIGN_PFX }}
      #     WINDOWS_SIGN_PASSWORD: ${{ secrets.WINDOWS_SIGN_PASSWORD }}
